model com.arsdigita.cms.contenttypes;

import com.arsdigita.kernel.ACSObject;
import com.arsdigita.cms.*;

object type SciOrganization extends GenericOrganizationalUnit {

    String[0..1] organizationShortDescription = ct_sciorga_organizations.shortdescription VARCHAR(500);
    String[0..1] organizationDescription = ct_sciorga_organizations.description CLOB;

    reference key ( ct_sciorga_organizations.organization_id );
}

association {
	    SciOrganization[0..n] organization = join ct_sciorga_departments.department_id
	                                       to ct_sciorga_organizations_departments_map.department_id,
					     join ct_sciorga_organizations_departments_map.organization_id
					       to ct_sciorga_organizations.organization_id;

            SciDepartment[0..n] departments = join ct_sciorga_organizations.organization_id
	    			  	           to ct_sciorga_organizations_departments_map.organization_id,
						 join ct_sciorga_organizations_departments_map.department_id
						   to ct_sciorga_departments.department_id;

	    Integer[0..1] departmentOrder = ct_sciorga_organizations_departments_map.department_order INTEGER;
	    Integer[0..1] organizationOrder = ct_sciorga_organizations_departments_map.organization_order INTEGER;
}

association {
	    SciOrganization[0..n] organization = join ct_sciorga_projects.project_id
	                                       to ct_sciorga_organizations_projects_map.project_id,
					     join ct_sciorga_organizations_projects_map.organization_id
					       to ct_sciorga_organizations.organization_id;

            SciProject[0..n] projects = join ct_sciorga_organizations.organization_id
	    			  	           to ct_sciorga_organizations_projects_map.organization_id,
						 join ct_sciorga_organizations_projects_map.project_id
						   to ct_sciorga_projects.project_id;

	    Integer[0..1] projectOrder = ct_sciorga_organizations_projects_map.project_order INTEGER;
	    Integer[0..1] organizationOrder = ct_sciorga_organizations_projects_map.organization_order INTEGER;
}

query getIdsOfContactsOfSciOrganization {
    BigDecimal contactId;

    do {
        select cms_organizationalunits_contact_map.contact_id 
        from cms_organizationalunits_contact_map        
        where cms_organizationalunits_contact_map.organizationalunit_id = :organization        
    } map {
        contactId = cms_organizationalunits_contact_map.contact_id;
    }
}

query getIdsOfDepartmentsOfSciOrganization {
    BigDecimal departmentId;

    do {
        select ct_sciorga_organizations_departments_map.department_id
        from ct_sciorga_organizations_departments_map        
        where ct_sciorga_organizations_departments_map.organization_id = :organization
    } map {
        departmentId = ct_sciorga_organizations_departments_map.department_id;
    }
}

query getIdsOfMembersOfSciOrganization {
    BigDecimal memberId;

    do {
        select cms_organizationalunits_person_map.person_id
        from cms_organizationalunits_person_map      
        where cms_organizationalunits_person_map.organizationalunit_id = :organization
    } map {
        memberId = cms_organizationalunits_person_map.person_id;
    }
}

query getIdsOfActiveMembersOfSciOrganization {
    BigDecimal memberId;

    do {
        select cms_organizationalunits_person_map.person_id
        from cms_organizationalunits_person_map        
        where cms_organizationalunits_person_map.organizationalunit_id = :organization 
        and cms_organizationalunits_person_map.status = 'active'
    } map {
        memberId = cms_organizationalunits_person_map.person_id;
    }
}

query getIdsOfAssociatedMembersOfSciOrganization {
    BigDecimal memberId;

    do {
        select cms_organizationalunits_person_map.person_id
        from cms_organizationalunits_person_map       
        where cms_organizationalunits_person_map.organizationalunit_id = :organization 
        and cms_organizationalunits_person_map.status = 'associated'
    } map {
        memberId = cms_organizationalunits_person_map.personId;
    }
}

query getIdsOfFormerMembersOfSciOrganization {
    BigDecimal memberId;

    do {
        select cms_organizationalunits_person_map.person_id
        from cms_organizationalunits_person_map   
        where cms_organizationalunits_person_map.organizationalunit_id = :organization 
        and (cms_organizationalunits_person_map.status = 'former' or cms_organizationalunits_person_map.status = 'associatedFormer')
    } map {
        memberId = cms_organizationalunits_person_map.personId;
    }
}

query getIdsOfProjectsOfSciOrganization {
    BigDecimal projectId;

    do {
        select ct_sciorga_organizations_projects_map.project_id
        from ct_sciorga_organizations_projects_map    
        where ct_sciorga_organizations_projects_map.organization_id = :organization
    } map {
        projectId = ct_sciorga_organizations_projects_map.project_id;
    }
}

query getIdsOfOngoingProjectsOfSciOrganization {
    BigDecimal projectId;

    do {
        select ct_sciorga_projects.project_id
        from ct_sciorga_organizations_projects_map
        join ct_sciorga_projects on ct_sciorga_organizations_projects_map.project_id = ct_sciorga_projects.project_id
        where ct_sciorga_organizations_projects_map.organization_id = :organization and ct_sciorga_projects.projectend >= ':today'
    } map {
        projectId = ct_sciorga_projects.project_id;
    }
}

query getIdsOfFinishedProjectsOfSciOrganization {
    BigDecimal projectId;

    do {
        select ct_sciorga_projects.project_id
        from ct_sciorga_organizations_projects_map
        join ct_sciorga_projects on ct_sciorga_organizations_projects_map.project_id = ct_sciorga_projects.project_id
        where ct_sciorga_organizations_projects_map.organization_id = :organization and ct_sciorga_projects.projectend < ':today'
    } map {
        projectId = ct_sciorga_projects.project_id;
    }
}

query getIdsOfPublicationLinksOfSciOrganization {
    BigDecimal linkId;

    do {
        select cms_related_links.related_link_id 
        from cms_related_links
        where cms_related_links.owner_id = :organization 
        and cms_related_links.link_list_name = 'SciOrganizationPublications'
    } map {
        linkId = cms_related_links.related_link_id;
    }
}

